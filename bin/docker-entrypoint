#!/bin/bash
set -e

# Docker entrypoint script para produÃ§Ã£o

echo "ğŸš€ Iniciando aplicaÃ§Ã£o..."

# Aguardar banco de dados estar disponÃ­vel em produÃ§Ã£o
if [ "$RAILS_ENV" = "production" ]; then
  echo "â³ Aguardando banco de dados..."
  max_attempts=30
  attempt=0
  until bundle exec rails runner "ActiveRecord::Base.connection.execute('SELECT 1')" > /dev/null 2>&1; do
    attempt=$((attempt + 1))
    if [ $attempt -ge $max_attempts ]; then
      echo "âŒ Falha ao conectar ao banco apÃ³s $max_attempts tentativas"
      echo "ğŸ” Verificando configuraÃ§Ãµes..."
      echo "DATABASE_URL: ${DATABASE_URL}"
      exit 1
    fi
    echo "Database nÃ£o estÃ¡ pronto - tentativa $attempt/$max_attempts..."
    sleep 5
  done
  echo "âœ… Banco de dados conectado!"
fi

# If running the rails server then create or migrate existing database
if [ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]; then
  if [ "$RAILS_ENV" != "production" ]; then
    ./bin/rails db:prepare
  fi
fi

# Executar comando passado para o container
echo "ğŸ¯ Executando: $@"
exec "${@}"
